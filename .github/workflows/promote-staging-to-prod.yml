name: Promote STAGING to PROD (rsync only)

on:
  workflow_call:
    inputs:
      staging_root:
        required: true
        type: string
      prod_root:
        required: true
        type: string
      prod_service_name:
        required: true
        type: string

    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
    - name: Setup SSH Key
      run: |
        echo "${{ secrets.VDS_SSH_KEY }}" > id_rsa
        chmod 600 id_rsa

    - name: Sync BACKEND (staging → prod)
      run: |
        rsync -avz --delete \
          -e "ssh -i id_rsa -o StrictHostKeyChecking=no" \
          root@${{ secrets.VDS_HOST }}:${{ inputs.staging_root }}/backend/ \
          root@${{ secrets.VDS_HOST }}:${{ inputs.prod_root }}/backend/

    - name: Sync FRONTEND (staging → prod)
      run: |
        rsync -avz --delete \
          -e "ssh -i id_rsa -o StrictHostKeyChecking=no" \
          root@${{ secrets.VDS_HOST }}:${{ inputs.staging_root }}/frontend/ \
          root@${{ secrets.VDS_HOST }}:${{ inputs.prod_root }}/frontend/

    - name: Restart PROD Service
      run: |
        ssh -i id_rsa -o StrictHostKeyChecking=no root@${{ secrets.VDS_HOST }} \
          "systemctl restart ${{ inputs.prod_service_name }}"
