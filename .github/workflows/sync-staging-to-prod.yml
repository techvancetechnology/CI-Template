name: Sync Staging to Prod

on:
  workflow_call:
    inputs:
      staging_root_path:
        required: true
        type: string
      prod_root_path:
        required: true
        type: string
      prod_service_name:
        required: true
        type: string
    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VDS_HOST }} >> ~/.ssh/known_hosts

      - name: Sync backend (STAGING → PROD)
        run: |
          ssh root@${{ secrets.VDS_HOST }} "
            rsync -av --delete \
              ${{ inputs.staging_root_path }}/backend/ \
              ${{ inputs.prod_root_path }}/backend/
          "

      - name: Sync frontend (STAGING → PROD)
        run: |
          ssh root@${{ secrets.VDS_HOST }} "
            rsync -av --delete \
              ${{ inputs.staging_root_path }}/frontend/ \
              ${{ inputs.prod_root_path }}/frontend/
          "

      - name: Restart PROD service
        run: |
          ssh root@${{ secrets.VDS_HOST }} \
            'systemctl restart ${{ inputs.prod_service_name }}'
