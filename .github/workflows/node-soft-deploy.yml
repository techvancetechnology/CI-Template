name: Reusable Node Deploy (Node Soft â€“ Single App)

on:
  workflow_call:
    inputs:
      remote_root_path:
        required: true
        type: string
        description: "Remote directory for node app"

      service_name:
        required: true
        type: string
        description: "systemd service name"

      node_path:
        required: false
        type: string
        default: .
        description: "Local node app path"

    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  Soft:
    runs-on: ubuntu-latest

    env:
      REMOTE_ROOT: ${{ inputs.remote_root_path }}

    steps:
      # =========================
      # CHECKOUT
      # =========================
      - uses: actions/checkout@v4

      # =========================
      # NODE
      # =========================
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ inputs.node_path }}/package-lock.json

      # =========================
      # BUILD
      # =========================
      - name: Build Node App
        run: |
          set -e
          cd "${{ inputs.node_path }}"

          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

          if npm run | grep -qE ' build'; then
            npm run build
          fi

          rm -rf "$GITHUB_WORKSPACE/publish/node"
          mkdir -p "$GITHUB_WORKSPACE/publish/node"

          rsync -rz \
            --exclude node_modules \
            --exclude .git \
            --exclude .github \
            ./ "$GITHUB_WORKSPACE/publish/node/"

      # =========================
      # SSH
      # =========================
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -R "${{ secrets.VDS_HOST }}" || true
          ssh-keyscan -H "${{ secrets.VDS_HOST }}" >> ~/.ssh/known_hosts

      # =========================
      # UPLOAD (SOFT)
      # =========================
      - name: Upload Node App
        run: |
          ssh github@${{ secrets.VDS_HOST }} "mkdir -p $REMOTE_ROOT"

          rsync -rz --delete \
            --no-times \
            --no-perms \
            --no-owner \
            --no-group \
            "$GITHUB_WORKSPACE/publish/node/" \
            "github@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/"

      # =========================
      # RESTART SERVICE
      # =========================
      - name: Restart Service
        run: |
          ssh github@${{ secrets.VDS_HOST }} \
            "sudo systemctl restart ${{ inputs.service_name }} &&
             sudo systemctl is-active --quiet ${{ inputs.service_name }}"
