name: Reusable Backend Deploy (BE Soft ‚Äì Single App)

on:
  workflow_call:
    inputs:
      remote_root_path:
        required: true
        type: string
        description: "Exact remote directory where backend is deployed"

      service_name:
        required: true
        type: string
        description: "Systemd service name"

      backend_path:
        required: false
        type: string
        default: backend
        description: "Local backend source path"

    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  Soft:
    runs-on: ubuntu-latest

    env:
      REMOTE_ROOT: ${{ inputs.remote_root_path }}

    steps:
      # =========================
      # CHECKOUT
      # =========================
      - name: Checkout
        uses: actions/checkout@v4

      # =========================
      # DOTNET
      # =========================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      # =========================
      # BUILD
      # =========================
      - name: Build Backend
        run: |
          set -e

          PROJECT=$(find "${{ inputs.backend_path }}" -maxdepth 3 -name "*.csproj" | head -n 1)
          [ -z "$PROJECT" ] && echo "‚ùå csproj not found" && exit 1

          echo "üî® Building $PROJECT"
          dotnet restore "$PROJECT"
          dotnet publish "$PROJECT" -c Release -o "$GITHUB_WORKSPACE/publish/backend"

      # =========================
      # SSH
      # =========================
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -R "${{ secrets.VDS_HOST }}" || true
          ssh-keyscan -H "${{ secrets.VDS_HOST }}" >> ~/.ssh/known_hosts

      # =========================
      # UPLOAD (SOFT)
      # =========================
      - name: Upload Backend
        run: |
          echo "üì¶ Uploading backend to $REMOTE_ROOT"

          ssh github@${{ secrets.VDS_HOST }} "mkdir -p $REMOTE_ROOT"

          rsync -rz --delete \
            --no-times \
            --no-perms \
            --no-owner \
            --no-group \
            "$GITHUB_WORKSPACE/publish/backend/" \
            "github@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/"

      # =========================
      # RESTART SERVICE
      # =========================
      - name: Restart Service
        run: |
          echo "üîÅ Restarting service: ${{ inputs.service_name }}"

          ssh github@${{ secrets.VDS_HOST }} \
            "sudo systemctl restart ${{ inputs.service_name }} &&
             sudo systemctl is-active --quiet ${{ inputs.service_name }}"
