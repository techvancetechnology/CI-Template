name: Reusable .NET + React HARD Deploy (clean & deploy)

on:
  workflow_call:
    inputs:
      remote_root_path:
        required: true
        type: string
      service_name:
        required: true
        type: string
      vite_api_base_url:
        required: true
        type: string
      vite_public_base_url:
        required: true
        type: string
      backend_path:
        required: true
        type: string
      backend_target_subdir:          # ✅ YENİ
        required: false
        type: string
        default: "."
      frontend_path:
        required: true
        type: string

    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  hard-deploy:
    runs-on: ubuntu-latest

    env:
      REMOTE_ROOT: ${{ inputs.remote_root_path }}
      BACKEND_TARGET: ${{ inputs.backend_target_subdir }}

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      - name: Build Backend
        run: |
          cd ${{ inputs.backend_path }}
          dotnet restore
          dotnet publish -c Release -o $GITHUB_WORKSPACE/publish/backend

      - uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Build Frontend
        env:
          VITE_API_BASE_URL: ${{ inputs.vite_api_base_url }}
          VITE_PUBLIC_BASE_URL: ${{ inputs.vite_public_base_url }}
        run: |
          cd ${{ inputs.frontend_path }}
          npm install
          npm run build
          mkdir -p $GITHUB_WORKSPACE/publish/frontend
          cp -r dist/* $GITHUB_WORKSPACE/publish/frontend/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VDS_HOST }} >> ~/.ssh/known_hosts

      - name: HARD CLEAN remote
        run: |
          ssh root@${{ secrets.VDS_HOST }} <<EOF
            systemctl stop ${{ inputs.service_name }} || true
            mkdir -p $REMOTE_ROOT/backend/$BACKEND_TARGET $REMOTE_ROOT/frontend
            rm -rf $REMOTE_ROOT/backend/$BACKEND_TARGET/*
          EOF

      - name: Upload Backend
        run: |
          rsync -avz --delete \
            $GITHUB_WORKSPACE/publish/backend/ \
            root@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/backend/$BACKEND_TARGET/

      - name: Upload Frontend
        run: |
          rsync -avz --delete \
            $GITHUB_WORKSPACE/publish/frontend/ \
            root@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/frontend/

      - name: Start Service
        run: |
          ssh root@${{ secrets.VDS_HOST }} \
            "systemctl start ${{ inputs.service_name }}"
