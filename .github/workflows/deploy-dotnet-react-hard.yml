name: Reusable .NET + React HARD Deploy (clean & deploy)

on:
  workflow_call:
    inputs:
      remote_root_path:
        required: true
        type: string

      service_name:
        required: true
        type: string

      vite_api_base_url:
        required: true
        type: string

      vite_public_base_url:
        required: true
        type: string

      backend_path:
        required: false
        type: string
        default: backend

      frontend_path:
        required: false
        type: string
        default: frontend

      backend_apps:
        required: false
        type: string
        default: backend

      # ✅ NEW – node worker support
      node_apps:
        required: false
        type: string
        default: ""
        description: "Comma separated node app folders (e.g. puppeteer-worker)"

      node_path:
        required: false
        type: string
        default: "."
        description: "Base path for node apps"

      deploy_mode:
        required: false
        type: string
        default: be+fe
        description: "be | fe | be+fe | be+node | fe+node | be+fe+node | node"

    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  hard-deploy:
    runs-on: ubuntu-latest

    env:
      REMOTE_ROOT: ${{ inputs.remote_root_path }}

    steps:
      - uses: actions/checkout@v4

      # =========================
      # BACKEND
      # =========================
      - uses: actions/setup-dotnet@v4
        if: inputs.deploy_mode != 'fe' && inputs.deploy_mode != 'node'
        with:
          dotnet-version: 9.0.x

      - name: Build Backend(s)
        if: inputs.deploy_mode != 'fe' && inputs.deploy_mode != 'node'
        run: |
          set -e
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"

          for app in "${APPS[@]}"; do
            if [ "$app" = "backend" ]; then
              PROJECT=$(find "${{ inputs.backend_path }}" -maxdepth 3 -name "*.csproj" | head -n 1)
              OUT="$GITHUB_WORKSPACE/publish/backend"
            else
              PROJECT=$(find "$app" -maxdepth 3 -name "*.csproj" | head -n 1)
              OUT="$GITHUB_WORKSPACE/publish/$app"
            fi

            [ -z "$PROJECT" ] && echo "❌ csproj not found" && exit 1

            dotnet restore "$PROJECT"
            dotnet publish "$PROJECT" -c Release -o "$OUT"
          done

      # =========================
      # NODE (FRONTEND + WORKER)
      # =========================
      - uses: actions/setup-node@v4
        if: inputs.deploy_mode != 'be'
        with:
          node-version: 20

      - name: Build Node Worker(s)
        if: inputs.node_apps != '' && (contains(inputs.deploy_mode, 'node') || inputs.deploy_mode == 'node')
        run: |
          set -e
          IFS=',' read -ra APPS <<< "${{ inputs.node_apps }}"

          for app in "${APPS[@]}"; do
            APP_PATH="${{ inputs.node_path }}/${app}"
            [ ! -d "$APP_PATH" ] && echo "❌ node app folder not found: $APP_PATH" && exit 1

            cd "$APP_PATH"

            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

            if npm run | grep -qE ' build'; then
              npm run build
            fi

            mkdir -p "$GITHUB_WORKSPACE/publish/$app"
            rsync -rz \
              --exclude node_modules \
              --exclude .git \
              --exclude .github \
              --exclude publish \
              ./ "$GITHUB_WORKSPACE/publish/$app/"

            cd "$GITHUB_WORKSPACE"
          done

      # =========================
      # FRONTEND
      # =========================
      - name: Build Frontend
        if: inputs.deploy_mode != 'be' && inputs.deploy_mode != 'node'
        env:
          VITE_API_BASE_URL: ${{ inputs.vite_api_base_url }}
          VITE_PUBLIC_BASE_URL: ${{ inputs.vite_public_base_url }}
        run: |
          cd ${{ inputs.frontend_path }}
          npm ci
          npm run build
          mkdir -p $GITHUB_WORKSPACE/publish/frontend
          cp -r dist/* $GITHUB_WORKSPACE/publish/frontend/

      # =========================
      # SSH
      # =========================
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VDS_HOST }}" >> ~/.ssh/known_hosts

      # =========================
      # STOP SERVICES
      # =========================
      - name: Stop Services
        if: inputs.deploy_mode != 'fe'
        run: |
          IFS=',' read -ra SERVICES <<< "${{ inputs.service_name }}"
          for svc in "${SERVICES[@]}"; do
            ssh github@${{ secrets.VDS_HOST }} "sudo systemctl stop $svc || true"
          done

      # =========================
      # CLEAN
      # =========================
      - name: Clean Remote FS
        run: |
          ssh github@${{ secrets.VDS_HOST }} "rm -rf $REMOTE_ROOT/* || true"

      # =========================
      # UPLOAD (HARD)
      # =========================
      - name: Upload Backend(s)
        if: inputs.deploy_mode != 'fe' && inputs.deploy_mode != 'node'
        run: |
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"
          for app in "${APPS[@]}"; do
            ssh github@${{ secrets.VDS_HOST }} "mkdir -p $REMOTE_ROOT/$app"
            rsync -rz \
              --no-times \
              --no-perms \
              --no-owner \
              --no-group \
              "$GITHUB_WORKSPACE/publish/$app/" \
              "github@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/$app/"
          done

      - name: Upload Node App(s)
        if: inputs.node_apps != '' && (contains(inputs.deploy_mode, 'node') || inputs.deploy_mode == 'node')
        run: |
          IFS=',' read -ra APPS <<< "${{ inputs.node_apps }}"
          for app in "${APPS[@]}"; do
            ssh github@${{ secrets.VDS_HOST }} "mkdir -p $REMOTE_ROOT/$app"
            rsync -rz \
              --no-times \
              --no-perms \
              --no-owner \
              --no-group \
              "$GITHUB_WORKSPACE/publish/$app/" \
              "github@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/$app/"
          done

      - name: Upload Frontend
        if: inputs.deploy_mode != 'be' && inputs.deploy_mode != 'node'
        run: |
          ssh github@${{ secrets.VDS_HOST }} "mkdir -p $REMOTE_ROOT/frontend"
          rsync -rz \
            --no-times \
            --no-perms \
            --no-owner \
            --no-group \
            "$GITHUB_WORKSPACE/publish/frontend/" \
            "github@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/frontend/"

      # =========================
      # START SERVICES
      # =========================
      - name: Restart Service(s)
        if: inputs.deploy_mode != 'fe'
        run: |
          set -e
          IFS=',' read -ra SERVICES <<< "${{ inputs.service_name }}"
          for svc in "${SERVICES[@]}"; do
            ssh \
              -o IdentitiesOnly=yes \
              -o StrictHostKeyChecking=no \
              github@${{ secrets.VDS_HOST }} \
              "sudo systemctl restart $svc && sudo systemctl is-active --quiet $svc"
          done
