name: Reusable .NET + React HARD Deploy (clean & deploy)

on:
  workflow_call:
    inputs:
      remote_root_path:
        required: true
        type: string

      service_name:
        required: true
        type: string
        description: "Comma separated systemd services (e.g. notifier.service,notifier-worker.service)"

      vite_api_base_url:
        required: true
        type: string

      vite_public_base_url:
        required: true
        type: string

      backend_path:
        required: false
        type: string
        default: backend

      frontend_path:
        required: false
        type: string
        default: frontend

      backend_apps:
        required: false
        type: string
        default: backend
        description: "Comma separated backend folders (api,worker or backend)"
    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true
jobs:
  hard-deploy:
    runs-on: ubuntu-latest

    env:
      REMOTE_ROOT: ${{ inputs.remote_root_path }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      # =========================================================
      # BUILD BACKEND(S)
      # =========================================================
      - name: Build Backend(s)
        run: |
          set -e
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"

          for app in "${APPS[@]}"; do
            echo "▶ Building backend: $app"

            if [ "$app" = "backend" ]; then
              APP_PATH="${{ inputs.backend_path }}"
            else
              APP_PATH="${{ inputs.backend_path }}/$app"
            fi

            dotnet restore "$APP_PATH"
            dotnet publish "$APP_PATH" -c Release -o "$GITHUB_WORKSPACE/publish/$app"
          done

      # =========================================================
      # BUILD INFO (PER BACKEND)
      # =========================================================
      - name: Generate build-info.json
        run: |
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"

          for app in "${APPS[@]}"; do
            cat <<EOF > $GITHUB_WORKSPACE/publish/$app/build-info.json
          {
            "app": "$app",
            "services": "${{ inputs.service_name }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "buildTime": "$BUILD_TIME",
            "pipeline": "github-actions",
            "runId": "${{ github.run_id }}"
          }
          EOF
          done

      # =========================================================
      # FRONTEND
      # =========================================================
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build Frontend
        env:
          VITE_API_BASE_URL: ${{ inputs.vite_api_base_url }}
          VITE_PUBLIC_BASE_URL: ${{ inputs.vite_public_base_url }}
        run: |
          cd ${{ inputs.frontend_path }}
          npm ci
          npm run build
          mkdir -p $GITHUB_WORKSPACE/publish/frontend
          cp -r dist/* $GITHUB_WORKSPACE/publish/frontend/

      # =========================================================
      # SSH
      # =========================================================
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$VDS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$VDS_HOST" >> ~/.ssh/known_hosts

      # =========================================================
      # STOP SERVICES (ALL)
      # =========================================================
      - name: Stop Service(s)
        run: |
          set -e
          IFS=',' read -ra SERVICES <<< "${{ inputs.service_name }}"

          for svc in "${SERVICES[@]}"; do
            echo "▶ Stopping service: $svc"
            ssh root@$VDS_HOST "systemctl stop $svc || true"
          done

      # =========================================================
      # HARD CLEAN (BACKEND + FRONTEND)
      # =========================================================
      - name: HARD CLEAN remote filesystem
        run: |
          set -e
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"

          for app in "${APPS[@]}"; do
            ssh root@$VDS_HOST "
              mkdir -p $REMOTE_ROOT/backend/$app
              rm -rf $REMOTE_ROOT/backend/$app/*
            "
          done

          ssh root@$VDS_HOST "
            mkdir -p $REMOTE_ROOT/frontend
            rm -rf $REMOTE_ROOT/frontend/*
          "

      # =========================================================
      # UPLOAD BACKEND(S)
      # =========================================================
      - name: Upload Backend(s)
        run: |
          set -e
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"

          for app in "${APPS[@]}"; do
            echo "▶ Uploading backend: $app"
            rsync -avz \
              $GITHUB_WORKSPACE/publish/$app/ \
              root@$VDS_HOST:$REMOTE_ROOT/backend/$app/
          done

      # =========================================================
      # UPLOAD FRONTEND
      # =========================================================
      - name: Upload Frontend
        run: |
          rsync -avz \
            $GITHUB_WORKSPACE/publish/frontend/ \
            root@$VDS_HOST:$REMOTE_ROOT/frontend/

      # =========================================================
      # START SERVICES (ALL)
      # =========================================================
      - name: Start Service(s)
        run: |
          set -e
          IFS=',' read -ra SERVICES <<< "${{ inputs.service_name }}"

          for svc in "${SERVICES[@]}"; do
            echo "▶ Starting service: $svc"
            ssh root@$VDS_HOST "systemctl start $svc"
          done
