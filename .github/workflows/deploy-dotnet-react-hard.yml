name: Reusable .NET + React HARD Deploy (clean & deploy)

on:
  workflow_call:
    inputs:
      remote_root_path:
        required: true
        type: string

      service_name:
        required: true
        type: string

      vite_api_base_url:
        required: true
        type: string

      vite_public_base_url:
        required: true
        type: string

      backend_path:
        required: false
        type: string
        default: backend

      frontend_path:
        required: false
        type: string
        default: frontend

      backend_apps:
        required: false
        type: string
        default: backend

    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  hard-deploy:
    runs-on: ubuntu-latest

    env:
      REMOTE_ROOT: ${{ inputs.remote_root_path }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      # === BACKEND BUILD (AYNI SOFT Ä°LE) ===
      - name: Build Backend(s)
        run: |
          set -e
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"

          for app in "${APPS[@]}"; do
            if [ "$app" = "backend" ]; then
              PROJECT=$(find backend -maxdepth 1 -name "*.csproj" | head -n 1)
              OUT_DIR="$GITHUB_WORKSPACE/publish/backend"
            else
              PROJECT=$(find "$app" -maxdepth 1 -name "*.csproj" | head -n 1)
              OUT_DIR="$GITHUB_WORKSPACE/publish/$app"
            fi

            dotnet restore "$PROJECT"
            dotnet publish "$PROJECT" -c Release -o "$OUT_DIR"

            BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            cat > "$OUT_DIR/build-info.json" <<'EOF'
          {
            "app": "__APP__",
            "services": "__SERVICES__",
            "commit": "__COMMIT__",
            "branch": "__BRANCH__",
            "buildTime": "__BUILD_TIME__",
            "pipeline": "github-actions",
            "runId": "__RUN_ID__"
          }
          EOF

            sed -i \
              -e "s/__APP__/$app/g" \
              -e "s#__SERVICES__#${{ inputs.service_name }}#g" \
              -e "s/__COMMIT__/${{ github.sha }}/g" \
              -e "s/__BRANCH__/${{ github.ref_name }}/g" \
              -e "s/__BUILD_TIME__/$BUILD_TIME/g" \
              -e "s/__RUN_ID__/${{ github.run_id }}/g" \
              "$OUT_DIR/build-info.json"
          done

      # === SSH ===
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$VDS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$VDS_HOST" >> ~/.ssh/known_hosts

      # === STOP SERVICES ===
      - name: Stop Services
        run: |
          IFS=',' read -ra SERVICES <<< "${{ inputs.service_name }}"
          for svc in "${SERVICES[@]}"; do
            ssh root@$VDS_HOST "systemctl stop $svc || true"
          done

      # === HARD CLEAN ===
      - name: Clean FS
        run: |
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"
          for app in "${APPS[@]}"; do
            ssh root@$VDS_HOST "rm -rf $REMOTE_ROOT/backend/$app/* || true"
          done
          ssh root@$VDS_HOST "rm -rf $REMOTE_ROOT/frontend/* || true"

      # === DEPLOY ===
      - name: Upload
        run: |
          IFS=',' read -ra APPS <<< "${{ inputs.backend_apps }}"
          for app in "${APPS[@]}"; do
            rsync -avz "$GITHUB_WORKSPACE/publish/$app/" root@$VDS_HOST:$REMOTE_ROOT/backend/$app/
          done
          rsync -avz "$GITHUB_WORKSPACE/publish/frontend/" root@$VDS_HOST:$REMOTE_ROOT/frontend/

      - name: Start Services
        run: |
          IFS=',' read -ra SERVICES <<< "${{ inputs.service_name }}"
          for svc in "${SERVICES[@]}"; do
            ssh root@$VDS_HOST "systemctl start $svc"
          done
