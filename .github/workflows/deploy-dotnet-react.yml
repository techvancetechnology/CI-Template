name: Reusable .NET + React Deploy

on:
  workflow_call:
    inputs:
      remote_root_path:
        required: true
        type: string

      service_name:
        required: true
        type: string

      backend_path:
        required: false
        type: string
        default: "backend"

      frontend_path:
        required: false
        type: string
        default: "frontend"

    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      REMOTE_ROOT: ${{ inputs.remote_root_path }}

    steps:
    # ---------------------------
    # CHECKOUT
    # ---------------------------
    - name: Checkout
      uses: actions/checkout@v3

    # ---------------------------
    # SETUP .NET
    # ---------------------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 9.0.x

    # ---------------------------
    # SETUP NODE
    # ---------------------------
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 20

    # ---------------------------
    # BUILD BACKEND
    # ---------------------------
    - name: Build Backend
      run: |
        cd ${{ inputs.backend_path }}
        dotnet restore
        dotnet publish -c Release -o ../publish/backend

    # ---------------------------
    # BUILD FRONTEND
    # ---------------------------
    - name: Build Frontend
      run: |
        cd ${{ inputs.frontend_path }}
        npm install
        npm run build
        mkdir -p ../publish/frontend
        cp -r dist/* ../publish/frontend/

    # ---------------------------
    # SSH KEY
    # ---------------------------
    - name: Setup SSH Key
      run: |
        echo "${{ secrets.VDS_SSH_KEY }}" > id_rsa
        chmod 600 id_rsa

    # ---------------------------
    # CLEAN REMOTE BACKEND
    # ---------------------------
    - name: Clean Remote Backend Folder
      run: |
        ssh -i id_rsa -o StrictHostKeyChecking=no root@${{ secrets.VDS_HOST }} \
          "rm -rf $REMOTE_ROOT/backend/*"

    # ---------------------------
    # CLEAN REMOTE FRONTEND
    # ---------------------------
    - name: Clean Remote Frontend Folder
      run: |
        ssh -i id_rsa -o StrictHostKeyChecking=no root@${{ secrets.VDS_HOST }} \
          "rm -rf $REMOTE_ROOT/frontend/*"

    # ---------------------------
    # UPLOAD BACKEND
    # ---------------------------
    - name: Upload Backend
      run: |
        scp -i id_rsa -o StrictHostKeyChecking=no -r publish/backend/* \
        root@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/backend/

    # ---------------------------
    # UPLOAD FRONTEND
    # ---------------------------
    - name: Upload Frontend
      run: |
        scp -i id_rsa -o StrictHostKeyChecking=no -r publish/frontend/* \
        root@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/frontend/

    # ---------------------------
    # RESTART API SERVICE
    # ---------------------------
    - name: Restart API Service
      run: |
        ssh -i id_rsa -o StrictHostKeyChecking=no root@${{ secrets.VDS_HOST }} \
          "systemctl restart ${{ inputs.service_name }}"
