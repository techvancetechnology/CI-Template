name: Reusable .NET + React Deploy (rsync, verified)

on:
  workflow_call:
    inputs:
      vite_api_base_url:
        required: true
        type: string

      vite_public_base_url:
        required: true
        type: string

      remote_root_path:
        required: true
        type: string

      service_name:
        required: true
        type: string

      backend_path:
        required: false
        type: string
        default: backend

      frontend_path:
        required: false
        type: string
        default: frontend

    secrets:
      VDS_HOST:
        required: true
      VDS_SSH_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      REMOTE_ROOT: ${{ inputs.remote_root_path }}

    steps:
      # --------------------------------------------------
      # CHECKOUT
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # --------------------------------------------------
      # BACKEND BUILD
      # --------------------------------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      - name: Build Backend
        run: |
          echo "üîß Building backend"
          cd ${{ inputs.backend_path }}
          dotnet restore
          dotnet publish -c Release -o $GITHUB_WORKSPACE/publish/backend

      # --------------------------------------------------
      # FRONTEND BUILD (CRITICAL PART)
      # --------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ inputs.frontend_path }}/package-lock.json

      - name: Build Frontend (with env validation)
        env:
          VITE_API_BASE_URL: ${{ inputs.vite_api_base_url }}
          VITE_PUBLIC_BASE_URL: ${{ inputs.vite_public_base_url }}
        run: |
          echo "üîé VITE_API_BASE_URL = $VITE_API_BASE_URL"
          echo "üîé VITE_PUBLIC_BASE_URL = $VITE_PUBLIC_BASE_URL"

          if [ -z "$VITE_API_BASE_URL" ]; then
            echo "‚ùå VITE_API_BASE_URL IS EMPTY ‚Äì ABORTING BUILD"
            exit 1
          fi

          if [ -z "$VITE_PUBLIC_BASE_URL" ]; then
            echo "‚ùå VITE_PUBLIC_BASE_URL IS EMPTY ‚Äì ABORTING BUILD"
            exit 1
          fi

          cd ${{ inputs.frontend_path }}

          echo "üì¶ Installing frontend dependencies"
          npm install

          echo "üèóÔ∏è Running Vite build"
          npm run build

          echo "üîç Verifying build output contains API URL"
          grep -R "$VITE_API_BASE_URL" dist \
            || (echo "‚ùå API URL NOT FOUND IN BUILD OUTPUT" && exit 1)

          echo "üìÅ Preparing publish directory"
          mkdir -p ../publish/frontend
          cp -r dist/* ../publish/frontend/

      # --------------------------------------------------
      # SSH SETUP
      # --------------------------------------------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VDS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VDS_HOST }} >> ~/.ssh/known_hosts

      # --------------------------------------------------
      # DEPLOY BACKEND
      # --------------------------------------------------
      - name: Upload Backend
        run: |
          echo "üöÄ Uploading backend to $REMOTE_ROOT/backend"
          rsync -avz --delete \
            publish/backend/ \
            root@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/backend/

      # --------------------------------------------------
      # DEPLOY FRONTEND
      # --------------------------------------------------
      - name: Upload Frontend
        run: |
          echo "üöÄ Uploading frontend to $REMOTE_ROOT/frontend"
          rsync -avz --delete \
            publish/frontend/ \
            root@${{ secrets.VDS_HOST }}:$REMOTE_ROOT/frontend/

      # --------------------------------------------------
      # RESTART SERVICE
      # --------------------------------------------------
      - name: Restart API Service
        run: |
          echo "üîÅ Restarting service ${{ inputs.service_name }}"
          ssh root@${{ secrets.VDS_HOST }} \
            "systemctl restart ${{ inputs.service_name }}"
